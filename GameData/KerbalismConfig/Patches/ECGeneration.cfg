// ============================================================================
// Make stock panel module work in the background and at high timewarp speeds
// ============================================================================

@PART[*]:HAS[@MODULE[ModuleDeployableSolarPanel]]:FOR[Kerbalism]
{
  // duplicate every ModuleDeployableSolarPanel
  // Some parts may use multiple MDSP modules,
  // so we have to add a SolarPanelFixer module each of them
  +MODULE[ModuleDeployableSolarPanel],*
  {
    // delete all values
    -* = delete
    // delete all possible nodes
    -powerCurve {}
    -temperatureEfficCurve {}
    -timeEfficCurve {}
    -UPGRADES {}
    // rename the module to SolarPanelFixer
    name = SolarPanelFixer
  }
}

// ============================================================================
// Fuel cells
// ============================================================================

@PART[FuelCell]:FOR[KerbalismPass0]
{
  @TechRequired = basicScience
}

KSM_MODULE_DEFINITION
{
  name = ECGenerationBase
  moduleName = ModuleKsmProcessController
  uiGroupName = ecGeneration
  uiGroupDisplayName = EC generation // TODO : localization
}

// cap 1 /6
@PART[FuelCell,FuelCellArray]:FOR[KerbalismPass0]
{
  !MODULE[ModuleResourceConverter] {}
  !RESOURCE[ElectricCharge] {}

  MODULE
  {
    name = ModuleKsmProcessController
    switchId = fuelCell
  }

  MODULE
  {
    name = ModuleB9PartSwitch
    switcherDescription = #autoLOC_502022 // Fuel Cell
    moduleID = fuelCell
    affectDragCubes = false
    affectFARVoxels = false
  }
}

@PART[FuelCell]:FOR[KerbalismPass2]
{
  @KSM_MODULE_DEFINITION[FuelCell*],*
  {
    capacity = 1
  }
}

@PART[FuelCellArray]:FOR[KerbalismPass2]
{
  @KSM_MODULE_DEFINITION[FuelCell*],*
  {
    capacity = 6
  }
}

// add subtypes to all part switches with a moduleID that matches fuelCell*
// do this AFTER[Kerbalism] so that other support configs can add fuel cells
// to parts without having to re-define this list
@PART[*]:HAS[@MODULE[ModuleB9PartSwitch]:HAS[#moduleID[fuelCell*]]]:FOR[KerbalismPass1]
{
  KSM_MODULE_DEFINITION 
  {
    name = FuelCellH2O2
    moduleName = ModuleKsmProcessController
    parentDefinition = ECGenerationBase
    processName = H2O2FuelCell
  }
  KSM_MODULE_DEFINITION 
  {
    name = FuelCellMPO2
    moduleName = ModuleKsmProcessController
    parentDefinition = ECGenerationBase
    processName = MPO2FuelCell
  }

  @MODULE[ModuleB9PartSwitch]:HAS[#moduleID[fuelCell*]],*
  {
    SUBTYPE
		{
			name = FuelCellH2O2
			title = #KERBALISM_H2O2FuelCell_title
			descriptionSummary = #KERBALISM_H2O2FuelCell_desc
      MODULE
      {
        IDENTIFIER {
          name = ModuleKsmProcessController
          switchId = #$../../../moduleID$
        }
        DATA {
          definition = #$../../name$
        }
      }
		}
    SUBTYPE
    {
      name = FuelCellMPO2
      title = #KERBALISM_MonopropO2FuelCell_title
      descriptionSummary = #KERBALISM_MonopropO2FuelCell_desc
      MODULE
      {
        IDENTIFIER {
          name = ModuleKsmProcessController
          switchId = #$../../../moduleID$
        }
        DATA {
          definition = #$../../name$
        }
      }
    }
  }
}

// ============================================================================
// RTG
// ============================================================================

@PART[rtg]:FOR[Kerbalism]
{
  !MODULE[ModuleGenerator] {}
  !MODULE[ModuleCoreHeat] {}

  MODULE
  {
    name = ModuleKsmProcessController
    definition = rtgEC
    KSM_MODULE_DEFINITION 
    {
      name = rtgEC
      parentDefinition = ECGenerationBase
      processName = radioisotopeGenerator
      capacity = 0.75
      running = true
    }
  }
}

// ============================================================================
// Launch clamps
// ============================================================================

@PART[launchClamp1]:FOR[Kerbalism]
{
  !MODULE[ModuleGenerator] {}
  
  MODULE
  {
    name = ModuleKsmProcessController
    definition = clampEC
    KSM_MODULE_DEFINITION 
    {
      name = clampEC
      parentDefinition = ECGenerationBase
      processName = electricGenerator
      capacity = 2.5
      running = true
    }
  }
}
